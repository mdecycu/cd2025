#VRML_SIM R2023b utf8

# 導入外部原型定義
EXTERNPROTO "../protos/TexturedBackground.proto"
EXTERNPROTO "../protos/TexturedBackgroundLight.proto"

# 場景資訊設定
WorldInfo {
  info [
    "fourbar linkage mechanism"
    "Created by: mdecycu"
    "Date: 2025-02-06 14:52:38 UTC"
  ]
}

# 攝影機視角設定
Viewpoint {
  # 使用四元數定義攝影機方向
  orientation -0.4975769539784069 0.5341062674660296 0.683482018726957 1.9987429693479375
  # 攝影機位置 (x, y, z)
  position 0.5777519356626547 -0.34125651873021023 3.5574117263147897
}

# 場景背景設定
TexturedBackground {
}
TexturedBackgroundLight {
}

# 主要機器人節點
Robot {
  children [
    # 基座定義
    DEF BASE Solid {
      # 基座位置，x=0.5 置中，z=0.5 抬高
      translation 0.5 0 0.5
      children [
        # 基座形狀定義
        DEF BASE Shape {
          # 基座外觀：使用 PBR 材質
          appearance PBRAppearance {
            baseColor 0.8 0.8 0.8  # 灰色
            roughness 1
            metalness 0
          }
          # 基座幾何形狀：1m 長，0.1m 寬高的長方體
          geometry Box {
            size 1 0.1 0.1
          }
        }
      ]
      name "base"
      boundingObject USE BASE
      physics Physics {
      }
    }

    # 第一個鉸鏈關節（驅動關節）
    DEF JOINT1 HingeJoint {
      # 關節參數設定
      jointParameters HingeJointParameters {
        axis 0 0 1  # 繞 z 軸旋轉
      }
      # 關節裝置：馬達和感測器
      device [
        # 馬達設定
        RotationalMotor {
          name "motor"
          maxVelocity 1    # 最大速度 1 rad/s
          maxTorque 100    # 最大扭矩 100 N⋅m
        }
        # 位置感測器
        PositionSensor {
          name "motor_sensor"
        }
      ]
      # 連接的第一根連桿（紅色）
      endPoint DEF LINK1 Solid {
        translation 0 0 0.5
        rotation 0 0 1 1.5708  # 90度，垂直向上
        children [
          # 連桿1的位置和形狀
          Pose {
            translation 0.2 0 0  # 移到連桿中心
            children [
              # 連桿1形狀定義
              DEF LINK1_SHAPE Shape {
                appearance PBRAppearance {
                  baseColor 1 0 0  # 紅色
                  roughness 1
                  metalness 0
                }
                geometry Box {
                  size 0.4 0.1 0.1  # 長 0.4m
                }
              }
            ]
          }
          # 第二個關節
          DEF JOINT2 HingeJoint {
            jointParameters HingeJointParameters {
              axis 0 0 1
              anchor 0.4 0 0  # 位於連桿1末端
            }
            # 連接的第二根連桿（綠色）
            endPoint DEF LINK2 Solid {
              translation 0.4 0 0
              rotation 0 0 -1 0.9630726812504711  # 初始角度
              children [
                # 連桿2的位置和形狀
                Pose {
                  translation 0.3 0 0
                  children [
                    # 連桿2形狀定義
                    DEF LINK2_SHAPE Shape {
                      appearance PBRAppearance {
                        baseColor 0 1 0  # 綠色
                        roughness 1
                        metalness 0
                      }
                      geometry Box {
                        size 0.6 0.1 0.1  # 長 0.6m
                      }
                    }
                  ]
                }
                # 第三個關節
                DEF JOINT3 HingeJoint {
                  jointParameters HingeJointParameters {
                    axis 0 0 1
                    anchor 0.6 0 0  # 位於連桿2末端
                  }
                  # 連接的第三根連桿（藍色）
                  endPoint DEF LINK3 Solid {
                    translation 0.6 0 0
                    rotation 0 0 -1 1.579522973054868  # 初始角度
                    children [
                      # 連桿3的位置和形狀
                      Pose {
                        translation 0.4 0 0
                        children [
                          # 連桿3形狀定義
                          DEF LINK3_SHAPE Shape {
                            appearance PBRAppearance {
                              baseColor 0 0 1  # 藍色
                              roughness 1
                              metalness 0
                            }
                            geometry Box {
                              size 0.9 0.1 0.1  # 長 0.9m
                            }
                          }
                        ]
                      }
                    ]
                    name "link3"
                    boundingObject USE LINK3_SHAPE
                    physics Physics {
                      density -1
                      mass 0.1
                    }
                  }
                }
              ]
              name "link2"
              boundingObject USE LINK2_SHAPE
              physics Physics {
                density -1
                mass 0.1
              }
            }
          }
        ]
        name "link1"
        boundingObject USE LINK1_SHAPE
        physics Physics {
          density -1
          mass 0.1
        }
      }
    }

    # 第四個關節（closed chain 約束）
    DEF JOINT4 HingeJoint {
      jointParameters HingeJointParameters {
        axis 0 0 1
        anchor 1 0 0  # 位於基座右端
      }
      # 連接回第三根連桿
      endPoint SolidReference {
        solidName "link3"
      }
    }
  ]
  name "four_bar_linkage"
  controller "fourbar_controller"
}